<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Moura | Registro de Baterias Defeituosas</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f2f2f2;
      padding: 20px;
    }
    h1, h2 {
      color: #003366;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select {
      width: 300px;
      padding: 5px;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #003366;
      color: white;
      border: none;
      cursor: pointer;
    }
    .bateria {
      background: white;
      padding: 10px;
      margin-top: 10px;
      border-left: 5px solid #003366;
    }
  </style>
</head>
<body>
  <h1>🔋 Moura | Registro de Baterias Defeituosas</h1>

  <div>
    <h2>Registrar nova bateria</h2>
    <label>Tipo:</label>
    <input id="tipo" type="text" />

    <label>Uso:</label>
    <select id="uso">
      <option value="automotivo">Automotivo</option>
      <option value="estacionária">Estacionária</option>
      <option value="acumulador">Acumulador</option>
      <option value="náutica">Náutica</option>
      <option value="industrial">Industrial</option>
    </select>

    <label>Número de Série:</label>
    <input id="numeroSerie" type="text" />

    <label>Data de Produção (DD/MM/AAAA):</label>
    <input id="dataProducao" type="text" placeholder="Ex: 22/10/2025" />

    <label>Lote:</label>
    <input id="lote" type="text" />

    <button onclick="registrarBateria()">Registrar</button>
  </div>

  <div>
    <h2>📋 Baterias Defeituosas Registradas</h2>
    <button onclick="listarBaterias()">Listar</button>
    <div id="lista"></div>
  </div>

  <script>
    const abi = [
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "numeroSerie",
				"type": "string"
			}
		],
		"name": "BateriaRegistrada",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_tipo",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_uso",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_numeroSerie",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_dataProducao",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_lote",
				"type": "string"
			}
		],
		"name": "registrarBateria",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "baterias",
		"outputs": [
			{
				"internalType": "string",
				"name": "tipo",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "uso",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "numeroSerie",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "dataProducao",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "lote",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			}
		],
		"name": "getBateria",
		"outputs": [
			{
				"internalType": "string",
				"name": "tipo",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "uso",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "numeroSerie",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "dataProducao",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "lote",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "listar",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "tipo",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "uso",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "numeroSerie",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "dataProducao",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "lote",
						"type": "string"
					}
				],
				"internalType": "struct BateriasDefeituosas.Bateria[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];
    const contratoEndereco = "0x95A0A6F7872a152B937DbDbC49f345ce271bFFbC";
    let web3;
    let contrato;

    async function conectar() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        contrato = new web3.eth.Contract(abi, contratoEndereco);
      } else {
        alert("⚠️ MetaMask não detectado.");
      }
    }

    async function registrarBateria() {
      await conectar();
      const tipo = document.getElementById("tipo").value;
      const uso = document.getElementById("uso").value;
      const numeroSerie = document.getElementById("numeroSerie").value;
      const dataProducao = document.getElementById("dataProducao").value;
      const lote = document.getElementById("lote").value;

      const contas = await web3.eth.getAccounts();
      await contrato.methods.registrarBateria(tipo, uso, numeroSerie, dataProducao, lote)
        .send({ from: contas[0] });

      alert("✅ Bateria registrada com sucesso!");
    }

    async function listarBaterias() {
      await conectar();
      const baterias = await contrato.methods.listar().call();
      const lista = document.getElementById("lista");
      lista.innerHTML = "";

      baterias.forEach((b, i) => {
        const div = document.createElement("div");
        div.className = "bateria";
        div.innerHTML = `
          <strong>#${i}</strong><br>
          Tipo: ${b.tipo}<br>
          Uso: ${b.uso}<br>
          Nº Série: ${b.numeroSerie}<br>
          Produção: ${b.dataProducao}<br>
          Lote: ${b.lote}
        `;
        lista.appendChild(div);
      });
    }
  </script>
</body>
</html>